---
import Layout from "@/layouts/Layout.astro";
import { createClient } from "@supabase/supabase-js";

const { cookies, redirect } = Astro;

const accessToken = cookies.get("sb-access-token");
if (!accessToken) {
  return redirect("/signin");
}

const supabaseServer = createClient(
  import.meta.env.SUPABASE_URL,
  import.meta.env.SUPABASE_ANON_KEY,
  {
    global: { headers: { Authorization: `Bearer ${accessToken.value}` } },
  }
);

const { data: { user } } = await supabaseServer.auth.getUser();
if (!user) {
  return redirect("/signin");
}

const { data: profile } = await supabaseServer
  .from("profiles")
  .select("*")
  .eq("id", user.id)
  .single();
---

<Layout>
  <main class="max-w-lg mx-auto mt-10 p-6 bg-white rounded-xl shadow space-y-6">
    <h1 class="text-2xl font-bold text-gray-800">Editar Perfil</h1>

    <form action="/api/perfil/update" method="post" enctype="multipart/form-data" class="space-y-4">
      <div>
        <label class="block text-gray-700 font-medium">Nombre</label>
        <input type="text" name="nombre" value={profile?.nombre ?? ""} required
          class="w-full text-slate-600 mt-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500" />
      </div>

      <div>
        <label class="block text-gray-700 font-medium">Apellidos</label>
        <input type="text" name="apellidos" value={profile?.apellidos ?? ""} 
          class="w-full text-slate-600 mt-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500" />
      </div>

      <div>
        <label class="block text-gray-700 font-medium">Teléfono</label>
        <input type="tel" name="telefono" value={profile?.telefono ?? ""} 
          class="w-full text-slate-600 mt-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500" />
      </div>

      <div>
        <label class="block text-gray-700 font-medium">Biografía</label>
        <textarea name="bio" rows="3"
          class="w-full px-3 py-2 mt-1 border rounded-lg shadow-sm focus:ring-2 focus:ring-green-500">{profile?.bio ?? ""}</textarea>
      </div>

      <div>
        <label class="block text-gray-700 font-medium">Rol</label>
        <select name="role" class="w-full px-3 py-2 mt-1 border rounded-lg focus:ring-2 focus:ring-green-500">
          <option value="usuario" selected={profile?.role === "usuario"}>Usuario</option>
          <option value="vendedor" selected={profile?.role === "vendedor"}>Vendedor</option>
          <option value="agencia" selected={profile?.role === "agencia"}>Agencia</option>
          <option value="organizacion" selected={profile?.role === "organizacion"}>Organización</option>
          <option value="guia" selected={profile?.role === "guia"}>Guía</option>
        </select>
      </div>

      <div>
        <label class="block text-gray-700 font-medium">Foto de perfil</label>
        {profile?.avatar_url && <img src={profile.avatar_url} alt="Avatar" class="w-16 h-16 rounded-full mb-2" />}
        <input type="file" name="avatar" accept="image/*" />
      </div>

      <div class="flex gap-3">
        <button type="submit" 
          class="flex-1 py-2 bg-green-600 text-white rounded-lg hover:bg-green-500 transition">
          Guardar cambios
        </button>
        <a href="/dashboard" 
          class="flex-1 py-2 text-center bg-gray-300 text-black rounded-lg hover:bg-gray-400 transition">
          Cancelar
        </a>
      </div>
    </form>
  </main>
</Layout>
