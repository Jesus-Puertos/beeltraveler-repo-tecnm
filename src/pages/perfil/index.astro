---
import Sidebar from "@/components/ui/menus/Sidebar.astro";
import Share from "@/icons/Share.astro";
import ProfileLayout from "@/layouts/ProfileLayout.astro";
import { supabase } from "@/lib/supabase";
import { createClient } from "@supabase/supabase-js";

const { cookies, redirect } = Astro;

// ðŸ”‘ Recuperar tokens de sesiÃ³n desde cookies
const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return redirect("/signin");
}

// ðŸ”‘ Cliente con sesiÃ³n activa
const supabaseServer = createClient(
  import.meta.env.SUPABASE_URL,
  import.meta.env.SUPABASE_ANON_KEY,
  {
    global: {
      headers: { Authorization: `Bearer ${accessToken.value}` },
    },
  }
);

// ðŸ”Ž Validar sesiÃ³n
const { data: { user }, error: userError } = await supabaseServer.auth.getUser();
if (userError || !user) {
  return redirect("/signin");
}

// ðŸ“Œ Perfil propio
let profile = null;
const { data: { session } } = await supabase.auth.getSession();

if (session?.user) {
  const { data } = await supabase
    .from("profiles")
    .select("nombre, apellidos, telefono, avatar_url, bio")
    .eq("id", user.id)
    .single();
  profile = data;
}
---

<ProfileLayout user={user} displayName={profile?.nombre} avatar={profile?.avatar_url}>
  <div>
    <Sidebar user={user} profile={profile} />

    <section class="max-w-5xl mx-auto mt-8 px-4">
      <!-- Header iOS: background + overlay + card -->
      <div class="relative">
        <div class="h-44 md:h-56 w-full rounded-3xl overflow-hidden shadow-xl">
          <img src="https://images.unsplash.com/photo-1503264116251-35a269479413" alt="Portada" class="w-full h-full object-cover" />
          <div class="absolute inset-0 bg-gradient-to-b from-black/20 via-black/10 to-black/30"></div>
        </div>

        <div class="absolute -bottom-16 md:-bottom-12 left-0 right-0 px-4 md:px-8">
          <div class="mx-auto grid grid-cols-[auto,1fr] gap-4 items-start rounded-2xl md:rounded-3xl bg-white/80 dark:bg-emerald-900/80 backdrop-blur-xl shadow-2xl p-4 md:p-6">
            <img id="avatar-preview" src={profile?.avatar_url ?? "/default-avatar.webp"} alt="Avatar" class="h-20 w-20 md:h-24 md:w-24 rounded-2xl ring-4 ring-white/70 object-cover" />

            <div class="flex flex-col gap-3">
              <div class="flex items-center justify-between gap-3">
                <h1 class="text-lg md:text-2xl font-bold tracking-tight text-emerald-900 dark:text-white">
                  {profile?.nombre} {profile?.apellidos}
                </h1>
                <div class="flex items-center gap-2">
                  <a href="/perfil/editar" class="px-3 py-1.5 md:px-4 md:py-2 rounded-full bg-emerald-600 text-white text-sm md:text-base hover:bg-emerald-500">Editar</a>
                  <button class="px-3 py-1.5 rounded-full border border-emerald-300/50 text-emerald-800 dark:text-emerald-200 hover:bg-emerald-50/50">
                    <Share />
                  </button>
                </div>
              </div>

              <div class="grid grid-cols-3 gap-2 md:gap-4">
                <div class="rounded-full bg-emerald-50 text-emerald-700 dark:bg-emerald-800/60 dark:text-emerald-200 py-2 text-center">
                  <p class="text-base font-bold">0</p>
                  <span class="text-xs">Siguiendo</span>
                </div>
                <div class="rounded-full bg-emerald-50 text-emerald-700 dark:bg-emerald-800/60 dark:text-emerald-200 py-2 text-center">
                  <p class="text-base font-bold">0</p>
                  <span class="text-xs">Seguidores</span>
                </div>
                <div class="rounded-full bg-emerald-50 text-emerald-700 dark:bg-emerald-800/60 dark:text-emerald-200 py-2 text-center">
                  <p class="text-base font-bold">0</p>
                  <span class="text-xs">Destinos</span>
                </div>
              </div>

              <p class="text-sm md:text-base text-slate-700 dark:text-slate-200">
                {profile?.bio ?? "Escribe una breve biografÃ­a para personalizar tu perfil."}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs segmentados -->
      <div class="pt-20 md:pt-16">
        <div class="mx-auto bg-white/70 dark:bg-emerald-900/60 backdrop-blur-md rounded-2xl shadow-xl p-2 md:p-3 max-w-3xl">
          <div class="grid grid-cols-3 gap-2">
            <button class="py-2 rounded-xl bg-emerald-600 text-white font-medium">Posts</button>
            <button class="py-2 rounded-xl text-emerald-700 dark:text-emerald-200 hover:bg-emerald-50/60 dark:hover:bg-white/5">Destinos</button>
            <button class="py-2 rounded-xl text-emerald-700 dark:text-emerald-200 hover:bg-emerald-50/60 dark:hover:bg-white/5">Insignias</button>
          </div>
        </div>
      </div>
    </section>
  </div>
</ProfileLayout>
