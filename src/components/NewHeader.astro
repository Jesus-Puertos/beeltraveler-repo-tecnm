---
import ThemeIcon from "../components/ui/icons/ThemeIcon.astro";
import NavLink from "../components/ui/links/NavLink.astro";

import LanguagePicker from "@/components/ui/LenguagePicker.astro";
import ThemeToggle from "./ui/icons/ThemeToggle.astro";
import SearchProfiles from "./SearchProfiles.astro";

const { user, displayName, avatar } = Astro.props;

const menuitems = [
  { href: "/", label: "Inicio" },
  {href: "/map" , label: "Mapa"}, 
  {href: "/calendar", label: "Calendario"},
  
  {href: "/marketplace" , label: 'MarketPlace'},
  {
    href: "https://485z3n3rwf9.typeform.com/to/tAwG4XPz",
    label: "Anunciar agencia",
  },
  { href: "/pricing", label: "Paquetes" },
  { href: "/articles", label: "Nuestras agencias" },
];
---

<header class="sticky inset-x-0 top-4 z-50 flex w-full flex-wrap text-sm md:flex-nowrap md:justify-start">
  <nav
    class="relative mx-2 w-full md:w-fit rounded-[36px] border border-emerald-200/60 bg-emerald-50/70 px-4 py-3 backdrop-blur-md 
           dark:border-emerald-800/40 dark:bg-green-800/80 dark:backdrop-blur-md 
           md:flex md:items-center md:justify-between md:px-6 md:py-0 lg:px-8 xl:mx-auto"
    aria-label="Global"
  >
    <!-- Logo + toggle móvil -->
    <div class="flex items-center justify-between">
      <a href={homeUrl} class="flex-none">
        <div class="h-[40px] md:h-[50px] lg:h-[60px] flex items-center">
          <img src="/logo.webp" alt="BeelPedia Logo" class="h-full w-auto object-contain" />
        </div>
      </a>

      <div class="ml-auto mr-5 md:hidden">
        <button
          type="button"
          class="hs-collapse-toggle flex h-8 w-8 items-center justify-center rounded-full 
                 text-sm font-bold text-emerald-700 transition duration-300 hover:bg-emerald-100 
                 dark:text-emerald-300 dark:hover:bg-emerald-800"
          data-hs-collapse="#navbar-collapse-with-animation"
          aria-controls="navbar-collapse-with-animation"
          aria-label="Toggle navigation"
        >
          <svg class="h-[1.25rem] w-[1.25rem] shrink-0 hs-collapse-open:hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" x2="21" y1="6" y2="6"></line>
            <line x1="3" x2="21" y1="12" y2="12"></line>
            <line x1="3" x2="21" y1="18" y2="18"></line>
          </svg>
          <svg class="hidden h-[1.25rem] w-[1.25rem] shrink-0 hs-collapse-open:block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6 6 18"></path>
            <path d="m6 6 12 12"></path>
          </svg>
        </button>
      </div>

      <!-- <span class="inline-block md:hidden">
  <ThemeToggle />
      </span> -->
    </div>

    <!-- Links y usuario -->
    <div id="navbar-collapse-with-animation" class="hs-collapse hidden grow basis-full transition-all duration-300 md:block">
      <div class="mt-5 flex flex-col gap-y-4 md:mt-0 md:flex-row md:items-center md:justify-end md:gap-x-6 lg:gap-x-8 md:ps-7">
        {strings.navBarLinks.map(link => (
          <NavLink url={link.url} name={link.name} />
        ))}

        
        <SearchProfiles />
        {user ? (
          <div class="flex justify-between items-center gap-3 bg-white/80 dark:bg-emerald-800/50 backdrop-blur-sm px-3 py-1.5 rounded-full shadow-sm border border-emerald-200/40 dark:border-emerald-700">
            <a href="/perfil">
                          <img src={avatar} alt={displayName} class="h-8 w-8 rounded-full object-cover ring-2 ring-emerald-400" />
            </a>            
            {/* <span class="inline font-medium text-emerald-900 dark:text-emerald-100 text-sm">
              👋 Hola, <span class="font-semibold">{displayName}</span>
            </span> */}

            <!-- Formulario para cerrar sesión -->
            <form id="signout-form" method="get" action="/api/auth/signout">
              <button
                type="submit"
                class="px-3 py-1 text-xs sm:text-sm font-semibold text-white bg-emerald-600 rounded-full hover:bg-emerald-500 transition"
              >
                Cerrar sesión
              </button>
            </form>
          </div>
        ) : (
          <a href="/signin" class="px-4 py-2 text-sm font-medium rounded-full bg-emerald-500 text-white hover:bg-emerald-600 transition">
            Iniciar sesión
          </a>
        )}
        <LanguagePicker />
        <span class="inline-block">
            <ThemeToggle />
        </span>
      </div>
    </div>
  </nav>
</header>

<!-- Limpieza de localStorage al cerrar sesión -->
<script is:inline>
  const form = document.getElementById("signout-form");
  if (form) {
    form.addEventListener("submit", () => {
      // 🔑 Limpia todos los tokens relacionados con Supabase
      for (const key of Object.keys(localStorage)) {
        if (key.startsWith("sb-")) localStorage.removeItem(key);
      }
      sessionStorage.clear();
    });
  }

</script>
